{% extends "core/base.html" %}

{% block navbar_search %}
<div class="navbar-search-wrapper">
    <input class="navbar-search input-card" type="search" name="search_term" id="navbar-search-term" placeholder="Search stocks..."
           hx-post="{% url 'search' %}"
           hx-trigger="keyup changed delay:300ms, focus"
           hx-target="#navbar-search-results"
           hx-indicator=".navbar-htmx-indicator"
           hx-vals='{"csrfmiddlewaretoken": "{{ csrf_token }}"}'
           autocomplete="off"
    >
    <span class="htmx-indicator navbar-htmx-indicator">...</span>
    <div id="navbar-search-results" class="navbar-search-dropdown">
        <!--Search results will be injected here-->
    </div>
</div>
{% endblock %}

{% block secondary_nav %}
<nav class="secondary-navbar">
    <ul>
        <li><a href="#qualitative-analysis">{{ stock.ticker }}</a></li>
        <li><a href="#stats">Stats</a></li>
        <li><a href="#chart">Chart</a></li>
        <li><a href="#aii-analysis">Aii Analysis</a></li>
        <li><a href="#news">News</a></li>
        <li><a href="#peers">Peers</a></li>
        <li><a href="#quarters">Quarters</a></li>
        <li><a href="#pnl">Profit & Loss</a></li>
        <li><a href="#balance-sheet">Balance Sheet</a></li>
        <li><a href="#cash-flow">Cash Flow</a></li>
        <li><a href="#ratios">Ratios</a></li>
        <li><a href="#shareholding">Shareholding</a> </li>
        <li><a href="#valuation">Valuation</a></li>
    </ul>
</nav>
{% endblock secondary_nav %}

{% block content %}
<div id="qualitative-analysis" class="details-container section-card">
    <div class="details-header">
        <div class="stock-header">
            <div class="stock-details">
                <h1 style="margin: 0 10px 0 0">{{ stock.name }}</h1>
                {% if stock.website %}
                    <a href="{{ stock.website }}" class="heading-link" target="_blank" rel="noopener noreferrer">
                        <h1 style="margin: 0">({{ stock.ticker }})</h1>
                    </a>
                {% else %}
                    <h1 style="margin: 0">{{ stock.ticker }}</h1>
                {% endif %}

                {% if current_price %}
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: var(--text-color); font-weight: bold">
                            â‚¹{{ current_price|floatformat:2 }}
                        </span>
                        {% if change and change_percent %}
                            <span style="color: {{ price_change_color }}; font-size: 0.9rem;">
                                {{ price_change_symbol }} {{ change|floatformat:2 }} ({{ change_percent|floatformat:2 }}%)
                            </span>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
        <div id="watchlist-button-container">
            {% if user.is_authenticated %}
                {% include 'users/partials/watchlist_button.html' %}
            {% endif %}
        </div>
    </div>
    {% if user.is_authenticated %}
        <div class="section-content"
             hx-get="{% url 'get_qualitative_analysis' stock.ticker %}"
             hx-trigger="click"
             hx-target="this"
             hx-swap="innerHTML">
            <div class="htmx-loading-container">
                <div class="htmx-loading-spinner"></div>
                <div class="htmx-loading-text">Generating Qualitative Analysis...</div>
            </div>
        </div>
    {% else %}
        <div class="button-container">
            <a href="{% url 'account_login' %}" class="styled-button">Get Qualitative Analysis</a>
        </div>
    {% endif %}

</div>

<div id="stats" class="stats-container section-card">
    <h2>Stock Statistics</h2>
    <div class="section-content"
         hx-get="{% url 'get_stats' stock.ticker %}"
         hx-trigger="load"
         hx-target="this"
         hx-swap="innerHTML">
        <div class="htmx-loading-container">
            <div class="htmx-loading-spinner"></div>
            <div class="htmx-loading-text">Loading Statistics...</div>
        </div>
    </div>
</div>

<div id="chart" class="chart-container section-card">
    <h2>Price Chart</h2>
    <div class="section-content"
         hx-get="{% url 'get_chart' stock.ticker %}"
         hx-trigger="load"
         hx-target="this"
         hx-swap="innerHTML">
        <div class="htmx-loading-container">
            <div class="htmx-loading-spinner"></div>
            <div class="htmx-loading-text">Loading Chart...</div>
        </div>
    </div>
</div>

<div id="aii-analysis" class="aii-analysis-container section-card">
    <h2>Aii Analysis</h2>
    <div class="section-content">
        <div id="analysis-content">
            {% if saved_analysis %}
                {% include "core/partials/aii_analysis.html" with analysis=saved_analysis analysis_data=analysis_data %}
            {% else %}
                <div class="button-container">
                    <button
                        hx-get="{% url 'get_analysis' stock.ticker %}"
                        hx-target="#analysis-content"
                        hx-swap="innerHTML"
                        class="styled-button">Generate aii Analysis
                    </button>
                </div>
            {% endif %}
            <div class="htmx-loading-container">
                <div class="htmx-loading-spinner"></div>
                <div class="htmx-loading-text">Loading Aii Analysis...</div>
            </div>
        </div>
    </div>
</div>

<div id="news" class="news-container section-card">
    <h2>Recent News</h2>
    <div class="section-content"
         hx-get="{% url 'get_news' stock.ticker %}"
         hx-trigger="click"
         hx-target="this"
         hx-swap="innerHTML">
        <div class="htmx-loading-container">
            <div class="htmx-loading-spinner"></div>
            <div class="htmx-loading-text">Loading News...</div>
        </div>
    </div>
</div>

<div id="peers" class="peers-container section-card">
    <h2>Peer Companies</h2>
    <div class="section-content"
         hx-get="{% url 'get_peers' stock.ticker %}"
         hx-trigger="click"
         hx-target="this"
         hx-swap="innerHTML">
        <div class="htmx-loading-container">
            <div class="htmx-loading-spinner"></div>
            <div class="htmx-loading-text">Loading Peers...</div>
        </div>
    </div>
</div>

<div id="quarters" class="quarterly-profits-container section-card">
    <h2>Quarterly Results</h2>
    <div class="section-content"
         hx-get="{% url 'get_profit_loss_quarterly' stock.ticker %}"
         hx-trigger="click"
         hx-target="this"
         hx-swap="innerHTML">
        <div class="htmx-loading-container">
            <div class="htmx-loading-spinner"></div>
            <div class="htmx-loading-text">Loading Quarterly Profits...</div>
        </div>
    </div>
</div>

<div id="pnl" class="profits-container section-card">
    <h2>Profit & Loss</h2>
    <div class="section-content"
         hx-get="{% url 'get_profit_loss' stock.ticker %}"
         hx-trigger="click"
         hx-target="this"
         hx-swap="innerHTML">
        <div class="htmx-loading-container">
            <div class="htmx-loading-spinner"></div>
            <div class="htmx-loading-text">Loading Profit & Loss...</div>
        </div>
    </div>
</div>

<div id="balance-sheet" class="balance-sheet-container section-card">
    <h2>Balance Sheet</h2>
    <div class="section-content"
         hx-get="{% url 'get_balance_sheet' stock.ticker %}"
         hx-trigger="click"
         hx-target="this"
         hx-swap="innerHTML">
        <div class="htmx-loading-container">
            <div class="htmx-loading-spinner"></div>
            <div class="htmx-loading-text">Loading Balance Sheet...</div>
        </div>
    </div>
</div>

<div id="cash-flow" class="cash-flow-container section-card">
    <h2>Cash Flow</h2>
    <div class="section-content"
         hx-get="{% url 'get_cash_flow' stock.ticker %}"
         hx-trigger="click"
         hx-target="this"
         hx-swap="innerHTML">
        <div class="htmx-loading-container">
            <div class="htmx-loading-spinner"></div>
            <div class="htmx-loading-text">Loading Cash Flow...</div>
        </div>
    </div>
</div>

<div id="ratios" class="ratios-container section-card">
    <h2>Ratios</h2>
    <div class="section-content"
         hx-get="{% url 'get_ratios' stock.ticker %}"
         hx-trigger="click"
         hx-target="this"
         hx-swap="innerHTML">
        <div class="htmx-loading-container">
            <div class="htmx-loading-spinner"></div>
            <div class="htmx-loading-text">Loading Ratios...</div>
        </div>
    </div>
</div>

<div id="shareholding" class="shareholding-container section-card">
    <h2>Shareholding Pattern</h2>
    <div class="section-content"
         hx-get="{% url 'get_shareholding' stock.ticker %}"
         hx-trigger="click"
         hx-target="this"
         hx-swap="innerHTML">
        <div class="htmx-loading-container">
            <div class="htmx-loading-spinner"></div>
            <div class="htmx-loading-text">Loading Shareholding...</div>
        </div>
    </div>
</div>

<div id="valuation" class="valuation-container section-card">
    <h2>Valuation Analysis</h2>
    <div class="section-content"
         hx-get="{% url 'get_valuation' stock.ticker %}"
         hx-trigger="click"
         hx-target="this"
         hx-swap="innerHTML">
         <div class="htmx-loading-container">
            <div class="htmx-loading-spinner"></div>
            <div class="htmx-loading-text">Calculating Fair Value...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('navbar-search-term');
    const searchResults = document.getElementById('navbar-search-results');
    let selectedIndex = -1;

    function updateSelection() {
        const items = searchResults.querySelectorAll('.dropdown-item');
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('keyboard-selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('keyboard-selected');
            }
        });
    }

    function selectItem(index) {
        const items = searchResults.querySelectorAll('.dropdown-item');
        if (items[index]) {
            const ticker = items[index].getAttribute('data-ticker');
            if (ticker) {
                window.location.href = `/stock/${ticker}`;
            }
        }
    }

    // Reset selection when new results are loaded
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.target.id === 'navbar-search-results') {
            selectedIndex = -1;
        }
    });

    searchInput.addEventListener('keydown', function(e) {
        const items = searchResults.querySelectorAll('.dropdown-item');

        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                if (items.length > 0) {
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection();
                }
                break;
            case 'ArrowUp':
                e.preventDefault();
                if (items.length > 0) {
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection();
                }
                break;
            case 'Enter':
                e.preventDefault();
                if (items.length > 0) {
                    if (selectedIndex >= 0) {
                        selectItem(selectedIndex);
                    } else {
                        selectItem(0);
                    }
                }
                break;
            case 'Escape':
                searchInput.blur();
                selectedIndex = -1;
                break;
        }
    });

    // Handle mouse hover to sync with keyboard navigation
    searchResults.addEventListener('mouseover', function(e) {
        const item = e.target.closest('.dropdown-item');
        if (item) {
            const items = searchResults.querySelectorAll('.dropdown-item');
            selectedIndex = Array.from(items).indexOf(item);
            updateSelection();
        }
    });

    // Reset selection when mouse leaves dropdown
    searchResults.addEventListener('mouseleave', function() {
        selectedIndex = -1;
        updateSelection();
    });

    // Reset selection when typing
    searchInput.addEventListener('input', function() {
        selectedIndex = -1;
    });

    // Handle mousedown on dropdown items (fires before blur event)
    searchResults.addEventListener('mousedown', function(e) {
        const item = e.target.closest('.dropdown-item');
        if (item) {
            e.preventDefault(); // Prevent input from losing focus
            const ticker = item.getAttribute('data-ticker');
            if (ticker) {
                window.location.href = `/stock/${ticker}`;
            }
        }
    });

    // Also handle click as backup
    searchResults.addEventListener('click', function(e) {
        const item = e.target.closest('.dropdown-item');
        if (item) {
            e.preventDefault();
            const ticker = item.getAttribute('data-ticker');
            if (ticker) {
                window.location.href = `/stock/${ticker}`;
            }
        }
    });
});
</script>
{% endblock %}
